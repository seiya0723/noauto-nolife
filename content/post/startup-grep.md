---
title: "grepコマンドの使い方と活用例について"
date: 2018-10-07T12:34:59+09:00
draft: false
thumbnail: "images/command.jpg"
categories: ["command"]
tags: [ "スタートアップシリーズ","ファイル検索", "正規表現","作業効率化" ]
---

<p>grep（Global Regular Expression Print）コマンドはその名の通り、指定したファイル全体から正規表現に一致する行を検索して表示するコマンドです。複数のファイルをまとめて検索したり、オプションでディレクトリを再帰的に検索したりする機能が用意されています。</p>

<p>特定の文字列を検索して、その文字列が含まれているファイルパスとその行を表示できるので、開発作業を行うときには活用することが多いです。</p>

<ul>
<li><a href="#chapter1">grepコマンドの使用方法</a></li>
<li><a href="#chapter2">活用例</a></li>
<li><a href="#chapter3">結論</a></li>
<li><a href="#chapter4">関連記事</a></li>
</ul>


<h2 id="chapter1">grepコマンドの使用方法</h2>

<p>grepコマンドの使用方法は簡単です。以下のコマンドを入力します。</p>

<pre><code>grep [オプション] [検索したい語句（正規表現）] [検索するファイルパス]</code></pre>

<p>よく使う基本的なオプションは以下のとおりです。</p>

<table>
<thead>
<tr>
<th>オプション</th><th>機能</th>
</tr>
</thead>
<tbody>
<tr>
<th>-r</th><th>指定したディレクトリに対して配下のディレクトリも含めて再帰的に検索をする</th>
</tr>
<tr>
<th>-v</th><th>[検索したい語句（正規表現）]に一致しない行を表示する（検索避け）</th>
</tr>
<tr>
<th>-i</th><th>アルファベットの大文字と小文字を区別しない</th>
</tr>
<tr>
<th>-n</th><th>[検索したい語句（正規表現）]ヒットした行の行番号を表示する</th>
</tr>
<tr>
<th>-s</th><th>[検索するファイルパス]が存在しない場合や権限が無い場合などに表示されるエラーメッセージの表示を抑止</th>
</tr>
<tr>
<th>-o</th><th>[検索したい語句（正規表現）]に一致した箇所とファイルパスだけを表示する。</th>
</tr>
<tr>
<th>-l</th><th>[検索したい語句（正規表現）]に一致したファイルパスだけを表示する</th>
</tr>
<tr>
<th>-q</th><th>検索してヒットした情報を出力しない。検索して最初にヒットした時点で動作は終了する</th>
</tr>
</tbody>
</table>

<p>grepのオプションの-lと-oは同時に利用できないので注意しましょう。<span style="color:#ff0000;">-lは一致したファイルパスだけを表示</span>するのに対して、<span style="color:#ff0000;">-oは一致した箇所とファイルパスだけを表示</span>するようになっています。双方の違いについてよくわからない場合は後述の活用例をご覧ください。</p>

<p>-rは指定したディレクトリの配下のファイルまで再帰的に調べてくれるのでよく使います。｜などを使用するときを除いて-rオプション無しでは非常に使い勝手が悪いので、覚えておきましょう。</p>

<p>-vは正規表現に一致しないすべての行を表示させるという、検索避けのような効果があります。指定した正規表現を含んだ一行を表示させず、それ以外を表示させるのでリダイレクトで検閲した文章をコピーする際などに使えます。もっとも一行が長いファイルでは検閲する範囲も大きくなってしまうので注意が必要です。私はこの-vオプションを｜で使い、検索避けをしています。</p>

<p>-nは行番号を表示してくれるオプションです。例えば使用している変数がどのファイルのどの行で使用されているのかを調べたいときに利用できます。ファイルを指定してvimを起動し、:set numberコマンドを入力した後/で前方検索しなくても良いので素早いです。</p>

<p>-qオプションは私には用途が思いつきません。一応、[検索したい語句（正規表現）]にヒットした場合動作が終了するので、検索にかかった時間を調べるために使うぐらいでしょうか。</p>

<h2 id="chapter2">活用例</h2>

具体的な活用例をまとめます。用途が思いつかない方は参考にしてください。

<h3>通常の活用例</h3>

<p>先述の通り、基本的にgrepコマンドは検索したい語句が含まれているファイルの一行を表示するだけでなく、ファイルのパスまで表示するようになっています。そのため、<span style="color:#ff0000;">検索したい語句が含まれているファイルを探したいときにも有効</span>です。</p>

<p>grepコマンドを使用することで開発作業を行うときには、どこでどのような関数や変数が使用されていて、どこにあるモジュールを呼び出しているのかがわかるようになるので便利です。<br>例えば、使用してはいけない特定の関数（goto文など）を使用しているソースファイルが、どこに存在しているのかを調べたいときには下記のように入力します。</p>

<pre><code>grep -rl [検索したい語句（正規表現）] ./*</code></pre>

<p>これでカレントディレクトリの中にあるファイルとその配下にあるディレクトリを再帰的に検索し、なおかつ[検索したい語句（正規表現）]を含むファイルのパスが表示されます。<br>たとえソースコードが難読化されて一行で表現されていたとしても、単純にファイルパスだけが表示されるので非常に見やすいです。</p>

<p>下記の画像は-rlオプションでカレントディレクトリから再帰的に検索し、sshを含むファイルパスを表示しています。</p>

<div class="img-center"><img src="/images/20181006003.jpg" alt="カレントディレクトリから再帰的に検索、sshを含むファイルパスを表示" /></div>

<p>もちろん、指定した語句がどれだけ使用されているのかを調べたいときには以下のコマンドを実行すれば良いだけです。これで特定の関数がどれだけ使用されているのかがわかります。</p>

<pre><code>grep -ro [検索したい語句（正規表現）] ./*</code></pre>

<p>カレントディレクトリから再帰的に検索して、[検索したい語句（正規表現）] に一致した箇所とファイルパスを表示できます。一致した箇所が複数だと、それがすべて表示されます。下記の画像は-roオプションでカレントディレクトリから再帰的に検索し、sshを含む箇所とファイルパスを表示しています。</p>

<div class="img-center"><img src="/images/20181006004.jpg" alt="カレントディレクトリから再帰的に検索、sshを含む箇所とファイルパスを表示" /></div>

<p>複数回語句が使用されているのであれば、その回数だけ表示されるので、てきとうなテキストファイルなどにリダイレクトして行数を調べれば語句の使用回数がわかります。下記のコマンドを実行して、vimで起動させ：set numberコマンドを入力すれば語句が使用されている回数がわかるのです。</p>

<pre><code>grep -ro [検索したい語句（正規表現）] ./* > new.txt</code></pre>

<p>もし、[検索したい語句（正規表現）]が使用されている行番号まで知りたい場合はオプションにnを追加します。</p>

<pre><code>grep -ron [検索したい語句（正規表現）] ./*</code></pre>

<div class="img-center"><img src="/images/20181006005.jpg" alt="カレントディレクトリから再帰的に検索、sshを含む箇所と行数に加えファイルパスまで表示" /></div>

<h3>grepコマンドの連結による活用例</h3>

<p>grepコマンドで表示される検索結果が膨大な場合は以下のコマンドを実行して見やすくします。</p>

<pre><code>grep [オプション] [検索したい語句（正規表現）] [検索するファイルパス] | less</code></pre>

<p>おなじみのlessコマンドです。カーソルキーやPageUpとPageDownによってスクロールできます。lessの状態から端末に戻るにはqキーを押します。</p>

<p>特定のコマンドとgrepを|で連結することで必要な情報だけを手に入れることができます。例えば、dpkgコマンドを利用してインストールされているパッケージを表示するときには-lオプションを使用しますが、それでは非常に見づらいので、以下のコマンドを実行します。</p>

<pre><code>dpkg -l | grep [検索したいパッケージ名や説明]</code></pre>

<p>これでインストールされているパッケージの名前だけでなく説明からも調べることができます。正式なパッケージ名がわからない場合でも説明でヒットすることがあるので非常に便利です。</p>


<p>grepとgrepを|で連結することによって、最初のgrepコマンドで検索した内容からさらに検索することが可能です。つまり、<span style="color:#ff0000;">特定の語句を表示させたくないときには以下のようにコマンドを実行すれば解決できます。</span></p>

<pre><code>grep -rv [表示したくない語句（正規表現）] [検索するファイルパス] | grep [検索したい語句（正規表現）]</code></pre>

<div class="img-center"><img src="/images/20181012001.jpg" alt="grepコマンドの-vオプションによる検索避け" /></div>

<p>もし、[表示したくない語句（正規表現）]で検索避けをする前の状態を比較したい時は以下のようにコマンドを入力します。</p>

<pre><code>grep -r [検索したい語句（正規表現）] [検索するファイルパス] && grep -rv [表示したくない語句（正規表現）] [検索するファイルパス] | grep [検索したい語句（正規表現）]</code></pre>

<div class="img-center"><img src="/images/20181012002.jpg" alt="grepコマンドの-vオプションによる検索避け、検索避け前の状態を表示する" /></div>

<p>&&は前述のコマンドが正常終了したときに後述のコマンドを実行するようになります。つまり、検索避けを実行する前の結果と検索避けを実行した後の結果を比較することができるのです。</p>

<p>もっとも、この辺の操作は正規表現を工夫することで連結せずに一回のコマンド入力で対処できそうですが。</p>


<h3>grepコマンドとfindコマンドの使い分け</h3>

<p>grepにはファイルの中身を検索するだけで、ファイル名やディレクトリ名そのものを検索することができないと思われがちです。しかし、<span style="color:#ff0000;">lsコマンドと|を活用すれば、grepコマンドでもファイル名やディレクトリ名を検索できます。</span>以下のコマンドはその例です。</p>

<pre><code>ls -alR ./* | grep [検索したいファイル名やディレクトリ名]</code></pre>

<p>このコマンドは指定したファイル名やディレクトリ名が、隠しファイルも含めてカレントディレクトリを再帰的に確認して存在しているかどうかと、権限や所有者などの詳細表示をしてくれます。</p>

<div class="img-center"><img src="/images/20181006006.jpg" alt="カレントディレクトリから再帰的にファイル名やディレクトリ名を検索して詳細情報を表示する" /></div>

<p>しかし上記のコマンドでは、ファイルやディレクトリのパスまで表示してくれません。検索対象のパスを調べたいのであれば、そんな回りくどいやり方をしなくてもfindコマンドを活用すれば一発です。</p>

<pre><code>find [検索する場所] -name [検索したいファイル名やディレクトリ名]</code></pre>

<p><span style="color:#ff0000;">grepはファイルの中身を検索する機能であるのに対して、findはファイル名やディレクトリ名を検索するものだと解釈した方が良いでしょう。</span></p>

<p>ちなみに、findにもオプションに権限を指定して検索することができますが、検索したファイルやディレクトリの権限まで表示してくれることはできないので、その点を使い分けると良いでしょう。</p>


<h2 id="chapter3">結論</h2>

<p>grepコマンドはよく利用されるファイル検索のコマンドで、パッケージの検索だけでなく開発作業時の変数の検索などにも活用できます。単独でgrepコマンドを使用するだけでなくパイプやリダイレクトと合わせて活用することで更に便利に利用できます。</p>

<p>ただし特定のファイル名やディレクトリ名のパスを調べることは難しいので、その場合はfindコマンドを利用しましょう。</p>

<h2 id="chapter4">関連記事</h2>

<h3>指定したファイル名を見つけるには</h3>

<p>【内部リンク】<a href="/post/20181106/">findコマンドの使い方と活用例</a></p>

<p>findコマンドとgrepコマンドが使えればファイルの検索も大幅に楽になるでしょう。特にfindコマンドは<code>-iname</code>と<code>-exec</code>が使えれば何でもできます。</p>

<p><b>nautilusでもファイルの検索は可能ですが、検索してヒットしたファイルの即実行はできない</b>でしょうし。覚えておいて損は無いコマンドの一つと言えます。</p>

<h3>grepの検索でヒットしたファイルの編集をワンライナーで実行する</h3>

<p>【内部リンク】<a href="/post/20181212/">sedコマンドの使い方と活用例</a></p>

<p>grepの検索でヒットしたファイルの編集はsedでできます。grepでは正規表現を使用した検索が主ですが、sedでは置換も行指定の抽出表示も自由自在です。</p>

<p>grepよりは使う機会が少ないように思えますが、<b>複数のファイルに点在している誤字修正には便利</b>でしょう。</p>

