---
title: "Djangoの埋め込み型カスタムテンプレートタグで明細表みたいなものを作る"
date: 2021-05-23T15:39:32+09:00
draft: true
thumbnail: "images/django.jpg"
categories: [ "サーバーサイド" ]
tags: [ "django","カスタムテンプレートタグ","上級者向け" ]
---

明細表を作る時、当然、小計や合計などを表示させる必要がある。しかし、Djangoのテンプレート言語DTLには計算をするテンプレートタグは用意されていないため、カスタムテンプレートタグを作る必要がある。

明細表の場合は、累計で演算を行うため、1つ前のレコードまでの累計を求めた上で加減算を繰り返す必要がある。故に、ただのカスタムテンプレートタグではなく、埋め込み型のカスタムテンプレートタグでなければならない。

本記事ではその方法を解説する。


## 元になるテンプレート




## カスタムテンプレートタグの定義





## 実装と発動














## ビューで合計値を計算する方法 VS 埋め込み型カスタムテンプレートタグ

ビューがデータを保存する時、小計もしくは合計を算出し、フィールドに値セットした上で保存させればいい思うかもしれない。

しかし、ビューで計算する場合、並び替えや削除などで帳尻が合わなくなる。削除機能をオミットさせ、並び順は常に一定とすれば実現可能ではあるが、何らかの影響でレコードが削除された時のことを考慮すると、実装は現実的とは言えない。


今回の埋め込み型カスタムテンプレートタグの場合、テンプレートにレンダリングする時に計算をしているので、並び替えによる値の食い違いなどが発生し得ない。レコードを削除しても、適切に計算が行われるため、問題はない。

ただ、ページネーションの実装には注意が必要である。ページネーションで移動する時、途中までの小計を算出しないと実現できない。


## 結論

意外と簡単そうに見える明細表を表示させるだけのウェブアプリであったとしても、裏では複雑な処理を行っている。

ちなみに、今回の計算処理はJavaScriptでも実現はできる。サーバーの負荷を考慮するとJavaScriptで実現させるのが最適解かも知れない。

