---
title: "Nginxのログをチェックする、ログの出力設定を変更する"
date: 2021-09-19T18:19:18+09:00
draft: true
thumbnail: "images/nginx.jpg"
categories: [ "インフラ" ]
tags: [ "nginx","システム管理","ウェブサーバー","セキュリティ" ]
---

事案が発生した時、まっさきに確認するべきがサーバーのログ。とりわけウェブサーバーのNginxのログ確認方法をここに記す。

## Nginxのログの見方

ログは`/var/log/nginx/access.log`に保管されてある。







## Nginxのログ出力を変更する(設定変更)

デフォルトではPOSTリクエストのボディが出力されない。そこでPOSTリクエストのボディも含ませる。

`/etc/nginx/nginx.conf`から設定の変更を施す。









これにより、SQLインジェクションやパスワードアタックなどを試みている端末のIPアドレスを特定できる。後はそのIPアドレスからのアクセスをシャットアウトするなりすると良いだろう。

誹謗中傷問題などのセキュリティ以外の事件が発生したときも、リクエストボディが見えるので、ウェブアプリ側がIPアドレスを記録していなくても、Nginxのログから特定できる。

## リモートホストのNginxのログを自動的にバックアップする

これもscpコマンドとcrontabを使えば簡単。


これでわざわざSSHでログインしなくてもゆっくりログが見れる。



## 結論

このようにウェブサーバーのログを確認するだけでウェブアプリ側には無い情報を手に入れることができる。もちろん、アプリ側が別途モデルや処理系を作って記録することもできるがとても手間がかかる。

今回はPOSTメソッドのボディの記録まで行ったが、GET文のクエリストリングはもともとデフォルトで表示されているので、特に追加の設定は必要ない。

そしてログのチェックでもgrepコマンドを多用する。正規表現が使えるので、送信元のIPアドレス、パラメータの値の表記ゆれも含めてまとめてヒットさせる際にとても便利だ。

