---
title: "【Django】ビューで生成した画像ファイルをバリデーションを経て、DBとメディアディレクトリに保存する【FileObject】"
date: 2024-02-15T11:40:32+09:00
lastmod: 2024-02-15T11:40:32+09:00
draft: true
thumbnail: "images/django.jpg"
categories: [ "サーバーサイド" ]
tags: [ "Django","上級者向け","tips" ]
---


例えば、Djangoのビューで画像の生成AIを動作させ、画像を生成。

生成した画像を、DBとメディアディレクトリに保存するケース。

この場合は、一旦生成した画像をメモリ空間内に保存し、FileObjectを使って読み込みする必要がある。

## ソースコード










## 応用例

このコードの動作原理は、

1. メモリ空間内に保存する
1. FileObjectでメモリ空間内のデータを読み込み
1. 読み込んだデータをバリデーションして保存

である。

故に、画像だけでなく他のファイル(PDF,Excel,Zip)でも応用が効く。

### 例1: テスト用紙(画像)をアップロード、赤ペン先生(AI)で判定、判定結果の画像もセットで保存する。

AIによる採点結果もセットで保存したい場合、本記事の方法が有効。

採点結果のDLは一回限りにさせたい場合は、わざわざメディアディレクトリとDBに保存する必要はないが、再度DLする可能性がある場合は保存すると良い。


### 例2: 複数枚のPDFをアップロード、ひとまとめにしたPDFファイルを保存する。

複数枚のPDFと、ひとまとめにしたPDFファイルを、まとめて保存する場合も有効。

また別のPDFファイルと連結させることもできる。

例えば、バラバラになっている領収書のPDFファイルをひとまとめにして、年ごとに保存しておくこともできるだろう。


### 例3: 画像を含むzipファイルをアップロード、ビューでzipを展開、中にある画像ファイルだけを保存する。

自炊ビューアーのようなウェブアプリを作りたい場合、本記事の方法が使える。

zipの中には画像ではないファイルが含まれる可能性もある。故にバリデーションは必須。

ビューでzipを展開、1対多でzipに含まれる画像ファイルを全て保存する形にすることで、自炊ビューアーアプリが作れる。


## 結論

Djangoでバリデーションをしてファイルを保存するとき、FileObjectになっている必要がある。

つまり、`request.FILES`で取得できるファイルのデータは、全てFileObjectになっていると言える。



## 関連記事


### バリデーションを経由せずに直接保存するには？

[Djangoでアップロードされた.aiと.psファイルのサムネイルを自動生成させる【PhotoShop,Illustrator】](/post/django-aips-thumbnail-autocreate/)

こちらでは、FileObjectにせず、生成した画像を直接メディアディレクトリに保存している。

もし、フォームクラスで特別なバリデーションルールが設定されていた場合、この方法は対応できない。

フォームクラスのバリデーションルールを絶対とする場合、バリデーションは必須になるため、本記事の方法を採用するとよいだろう。



### 生成したファイルをダウンロードさせるには？

DBに保存するのではなく、生成した画像をDLもしくは表示させる形式にしたい場合、下記のようにFileResponseを返すようにする。

[【Django】openpyxlでエクセルファイルを新規作成、バイナリでダウンロードする【FileResponse】](/post/django-openpyxl/)

